#!/bin/bash
# Pre-commit hook: enforce version sync between ralph.sh and CHANGELOG.md
#
# Install: ln -sf ../../hooks/pre-commit .git/hooks/pre-commit

set -euo pipefail

SCRIPT_VER=$(grep -oE '^VERSION="[0-9]+\.[0-9]+\.[0-9]+"' ralph.sh | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
CHANGELOG_VER=$(grep -oE '^## Version [0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

if [[ -z "$SCRIPT_VER" ]]; then
  echo "❌ Could not extract version from ralph.sh"
  exit 1
fi

if [[ -z "$CHANGELOG_VER" ]]; then
  echo "❌ Could not extract version from CHANGELOG.md"
  exit 1
fi

if [[ "$SCRIPT_VER" != "$CHANGELOG_VER" ]]; then
  echo "❌ Version mismatch:"
  echo "   ralph.sh:     $SCRIPT_VER"
  echo "   CHANGELOG.md: $CHANGELOG_VER"
  echo ""
  echo "Update both files to match before committing."
  exit 1
fi

# Optional: warn if CHANGELOG date is stale
CHANGELOG_DATE=$(grep -oE '^## Version [0-9.]+ \([0-9-]+\)' CHANGELOG.md | head -1 | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || true)
TODAY=$(date +%Y-%m-%d)
if [[ -n "$CHANGELOG_DATE" && "$CHANGELOG_DATE" != "$TODAY" ]]; then
  echo "⚠️  CHANGELOG date ($CHANGELOG_DATE) is not today — update if releasing"
fi

echo "✓ Version check passed: $SCRIPT_VER"
